---
description: План рефакторинга и улучшения архитектуры проекта Ozon Seller Bot.
---

### 1. Унификация работы с кэшем (Memory System)
В данный момент механизм работы с JSON-файлами размазан по проекту (прямые вызовы json.load, свои реализации).
**Задача:** Централизовать работу с файловым кэшем.

- [ ] Создать модуль `modules_common/cache_manager.py`.
- [ ] Реализовать класс `JsonCacheManager` с методами `get(key)`, `set(key, value)`, использующий `config_package.json_utils`.
- [ ] Внедрить использование менеджера в `modules_sales/sales_forecast.py` (хранение выбранного метода прогноза).
- [ ] Внедрить использование менеджера в `modules_sales/sales_facts_store.py` (кэширование фактов).

### 2. Очистка конфигурации (Configuration Cleanup)
Модули используют `os.getenv` и `load_dotenv` напрямую, игнорируя типизированный `settings.py`.
**Задача:** Перевести модули продаж на использование глобального объекта `settings`.

- [ ] В `modules_sales/sales_forecast.py`:
    - Заменить `WATCH_SKU`, `ES_ALPHA` и прочие константы на `settings.parsed_watch_sku`, `settings.es_alpha`.
    - Удалить блок `load_dotenv` и ручное чтение `.env`.
- [ ] В `modules_sales/sales_facts_store.py`:
    - Убрать ручной парсинг `WATCH_SKU` и алиасов. Использовать `settings.parsed_watch_sku` и `settings.city_config` (при необходимости).
    - Удалить `load_dotenv`.

### 3. Разделение ответственности в Sales (Refactoring)
`sales_forecast.py` смешивает логику API, расчетов и форматирования текста.
**Задача:** Разделить код на слои: Service (логика) и View (представление).

- [ ] Создать `modules_sales/services.py`:
    - Перенести логику получения данных (`_fetch_series_from_api`) и математику (`_ma`, `_es`).
    - Методы должны возвращать структуры данных (DTO/dict), а не текст.
- [ ] Создать `modules_sales/views.py`:
    - Перенести функции форматирования (`forecast_text`, `facts_text`).
    - Функции принимают данные и возвращают готовые строки сообщений.
- [ ] Обновить `sales_forecast.py` (или удалить, заменив импорты), чтобы он использовал новые слои.

### 4. Структурированное логирование (Observability)
Логирование настроено базово и разрозненно.
**Задача:** Внедрить единую конфигурацию.

- [ ] Создать `config_package/logging_config.py`.
    - Функция `setup_logging()` с JSON-форматтером (опционально) или унифицированным форматом.
- [ ] Применить `setup_logging()` в точке входа `bot.py`.

### 5. Устранение дублирования точек входа (Final Integration)
Существуют `bot.py` (новая архитектура) и `main.py` (легаси).
**Задача:** Сделать `bot.py` единственной точкой входа.

- [ ] Проверить `main.py` на наличие уникального кода, который отсутствует в `routers/` и `handlers/`.
- [ ] Перенести недостающие обработчики (если есть) в соответствующие роутеры.
- [ ] Удалить `main.py`.
- [ ] Переименовать `bot.py` в `main.py` (или оставить `bot.py`, но обновить документацию по запуску).
